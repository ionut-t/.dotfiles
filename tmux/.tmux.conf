# ============================================================================
# GENERAL SETTINGS
# ============================================================================

# Set default terminal with true color support
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Start indexing windows at 1 instead of 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable mouse support
set -g mouse on

# Use vi mode for copy mode
setw -g mode-keys vi

# Increase scrollback buffer size
set -g history-limit 10000

# Faster command sequences (reduce delay)
set -s escape-time 0

# Increase display time for messages
set -g display-time 2000

# Focus events enabled for terminals that support them
set -g focus-events on

# Aggressive resize (useful for multi-monitor setups)
setw -g aggressive-resize on

# ============================================================================
# PREFIX KEY
# ============================================================================

# Change prefix from C-b to C-a
set -g prefix C-a
unbind C-b
bind-key C-a send-prefix

# ============================================================================
# KEY BINDINGS
# ============================================================================

# Window management
bind c new-window -c "#{pane_current_path}"

# Split panes
unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

# Reload config
unbind r
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Terminal reset
bind-key -n C-z send-keys C-z \; send-keys -R \; clear-history \; send-keys C-m \; display-message "Terminal has been reset"

# Better pane navigation with awareness
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Quick window switching
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# Kill pane/window without confirmation
bind x kill-pane
bind X kill-window

# Toggle synchronize-panes
bind S set-window-option synchronize-panes\; display-message "synchronize-panes is now #{?pane_synchronized,on,off}"

# Popup windows
bind g display-popup -E -w 60% -h 60% -d "#{pane_current_path}"

bind y new-window -n "yazi" -c "#{pane_current_path}" "yazi"

# File finder with preview (opens in nvim)
bind f display-popup -E -w 80% -h 80% -d "#{pane_current_path}" \
  "fzf --preview 'bat --color=always --style=numbers --line-range=:500 {}' \
   --header 'Find' \
   --bind 'enter:execute(nvim {})+abort'"

# Grep search with preview
bind / display-popup -E -w 80% -h 80% -d "#{pane_current_path}" \
  "rg --color=always --line-number --no-heading --smart-case '' | \
   fzf --ansi --delimiter ':' \
   --preview 'bat --color=always {1} --highlight-line {2}' \
   --preview-window 'up,60%,border-bottom,+{2}+3/3' \
   --header 'Search in files' \
   --bind 'enter:execute(nvim +{2} {1})+abort'"

# Process killer (clean format: PID, CPU, MEM, COMMAND)
bind p display-popup -E -w 80% -h 80% \
  "ps aux | awk 'NR==1 {print \"PID\t%CPU\t%MEM\tCOMMAND\"; next} {printf \"%s\t%s\t%s\t\", \$2, \$3, \$4; for(i=11;i<=NF;i++) printf \"%s \", \$i; print \"\"}' | \
   column -t -s $'\t' | \
   fzf --header-lines=1 --header 'Select process to kill (Esc to cancel)' | \
   awk '{print \$1}' | xargs -r kill"

# Session manager (tsm)
set-hook -g after-select-window 'run-shell "tsm record"'
set-hook -g after-new-window 'run-shell "tsm record"'

bind o display-popup -E -w 80% -h 80% "tsm switch-window --preview"
bind O display-popup -E -w 40% -h 40% "tsm switch"
bind k display-popup -E -w 40% -h 40% "tsm kill --quiet"
bind n display-popup -E -w 80% -h 80% "tsm new --preview --quiet"
bind M display-popup -E -w 80% -h 80% "tsm move-window --quiet"
bind W display-popup -E -w 80% -h 80% "tsm workspace"
bind l run-shell "tsm last-window --current-session"
bind L run-shell "tsm last-session"
bind m command-prompt -p "Swap with window:" "run-shell 'tsm swap-window -t %% --quiet'"

# Commit changes (bark)
bind b new-window -n "bark" -c "#{pane_current_path}" "bark commit"
bind B new-window -n "bark-all" -c "#{pane_current_path}" "bark commit --all"

# Vi copy mode bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# View scrollback with line numbers
bind v run-shell "tmux capture-pane -p -S -5000 | sed 's/\x1b\[[0-9;]*m//g' > /tmp/tmux-scrollback && tmux new-window 'nvim -R /tmp/tmux-scrollback'"

# ============================================================================
# THEME & STATUS BAR
# ============================================================================

# Theme - Catppuccin
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_text " #{window_name}"
set -g @catppuccin_window_status_style "slanted" # options: none, slanted, rounded
set -g @catppuccin_window_current_text " #{window_name}"
set -g @catppuccin_date_time_text " %m/%d/%y %H:%M"

# Status bar configuration
set -g status-position bottom
set -g status-justify centre
set -g status-left-length 100
set -g status-right-length 100

# Left side: session only
set -g status-left "#{E:@catppuccin_status_session}"

# Right side: cpu, battery, date_time
set -gF status-right "#{E:@catppuccin_status_cpu}"
set -agF status-right "#{E:@catppuccin_status_battery}"
set -agF status-right "#{E:@catppuccin_status_date_time}"

# ============================================================================
# PLUGINS
# ============================================================================

# TPM - Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Navigation
set -g @plugin 'christoomey/vim-tmux-navigator'

# Theme plugin (loads catppuccin theme configured above)
run ~/.config/tmux/plugins/catppuccin/tmux/catppuccin.tmux

# Status bar plugins
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'

# Session resurrection (disabled)
# set -g @resurrect-capture-pane-contents 'on'
# set -g @continuum-restore 'on'

# ============================================================================
# INITIALIZE TPM (keep this at the very bottom)
# ============================================================================

run '~/.tmux/plugins/tpm/tpm'
